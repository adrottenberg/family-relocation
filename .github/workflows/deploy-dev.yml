name: Deploy to Dev

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: familyrelocation-api-dev
  S3_BUCKET: dev-unionvaad-web
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

jobs:
  # Job 1: Build and test the API
  build-api:
    name: Build & Test API
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --no-build --verbosity normal
        continue-on-error: true  # TODO: Remove once .NET 10 test reporting issue is resolved

      - name: Configure AWS credentials for ECR
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Job 2: Build and deploy frontend
  build-frontend:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: build-api
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/FamilyRelocation.Web/package-lock.json

      - name: Install dependencies
        working-directory: src/FamilyRelocation.Web
        run: npm ci

      - name: Build frontend
        working-directory: src/FamilyRelocation.Web
        env:
          VITE_API_URL: https://dev.unionvaad.com/api
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        working-directory: src/FamilyRelocation.Web
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  # Job 3: Deploy API to EC2
  deploy-api:
    name: Deploy API to EC2
    runs-on: ubuntu-latest
    needs: build-api
    environment: dev

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # Pull the latest image
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

            # Stop and remove existing container
            docker stop familyrelocation-api || true
            docker rm familyrelocation-api || true

            # Get secrets from Secrets Manager
            # NOTE: Dev uses RDS-managed secret with rotation DISABLED.
            # TODO (PROD): Switch to IAM Database Authentication instead of username/password.
            #   - Enable IAM auth on RDS instance
            #   - Use EC2 IAM role to generate auth tokens
            #   - Connection string: "Host=...;Database=...;Username=<iam_user>;Password=<generated_token>"
            #   - See: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html
            RDS_SECRET=$(aws secretsmanager get-secret-value --secret-id "rds!db-801f66af-8d3a-4f82-82bb-bfd53f741372" --query SecretString --output text)
            DB_USER=$(echo $RDS_SECRET | jq -r '.username')
            DB_PASS=$(echo $RDS_SECRET | jq -r '.password')
            DB_HOST="familyrelocation-dev.cytoakkck81s.us-east-1.rds.amazonaws.com"
            DB_NAME="familyrelocation"
            DB_CONNECTION="Host=${DB_HOST};Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASS}"

            COGNITO_SECRET=$(aws secretsmanager get-secret-value --secret-id familyrelocation/dev/cognito --query SecretString --output text)
            COGNITO_POOL_ID=$(echo $COGNITO_SECRET | jq -r '.UserPoolId')
            COGNITO_CLIENT_ID=$(echo $COGNITO_SECRET | jq -r '.ClientId')
            COGNITO_CLIENT_SECRET=$(echo $COGNITO_SECRET | jq -r '.ClientSecret')
            COGNITO_AUTHORITY="https://cognito-idp.${{ env.AWS_REGION }}.amazonaws.com/${COGNITO_POOL_ID}"
            S3_BUCKET=$(aws secretsmanager get-secret-value --secret-id familyrelocation/dev/s3 --query SecretString --output text | jq -r '.BucketName')

            # Run new container
            docker run -d \
              --name familyrelocation-api \
              --restart unless-stopped \
              -p 8080:8080 \
              -e "ConnectionStrings__DefaultConnection=$DB_CONNECTION" \
              -e "AWS__Cognito__Authority=$COGNITO_AUTHORITY" \
              -e "AWS__Cognito__UserPoolId=$COGNITO_POOL_ID" \
              -e "AWS__Cognito__ClientId=$COGNITO_CLIENT_ID" \
              -e "AWS__Cognito__ClientSecret=$COGNITO_CLIENT_SECRET" \
              -e "AWS__S3__BucketName=$S3_BUCKET" \
              -e "AWS__Region=${{ env.AWS_REGION }}" \
              -e "ASPNETCORE_ENVIRONMENT=Production" \
              -e "Cors__AllowedOrigins__0=https://dev.unionvaad.com" \
              ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

            # Clean up old images
            docker image prune -af

            # Health check (with logging on failure for debugging)
            sleep 10
            if ! curl -f http://localhost:8080/health; then
              echo "Health check failed. Container logs:"
              docker logs familyrelocation-api --tail 50
              echo "Container status:"
              docker ps -a | grep familyrelocation
              exit 1
            fi

  # Job 4: Notify on completion
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-api, build-frontend, deploy-api]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.build-api.result }}" == "success" ] && \
             [ "${{ needs.build-frontend.result }}" == "success" ] && \
             [ "${{ needs.deploy-api.result }}" == "success" ]; then
            echo "Deployment successful!"
            echo "Frontend: https://dev.unionvaad.com"
            echo "API: https://dev.unionvaad.com/api"
          else
            echo "Deployment failed!"
            exit 1
          fi
